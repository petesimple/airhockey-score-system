<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json" />
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<meta name="theme-color" content="#121212">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Air Hockey Score System</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

.scoreboard {
font-family: 'Arial Black', sans-serif;
font-size: 1.2em;
background-color: #000;
color: #f0f0f0;
padding: 20px 40px;
border-radius: 8px;
display: inline-block;
margin-top: 20px;
border: 2px solid #444;
}
#scoreBoard { margin-bottom: 10px; }

#timer {
font-family: 'Arial Black', sans-serif;
font-size: 3em;
font-weight: bold;
background-color: #000;
color: white;
padding: 10px 30px;
border-radius: 8px;
display: inline-block;
margin-top: 20px;
border: 2px solid #444;
cursor: pointer;
}

html, body {
font-family: Arial, sans-serif;
text-align: center;
padding: 30px;
background-color: #121212;
color: #f0f0f0;
touch-action: manipulation;
}

.button-columns { display: flex; justify-content: center; gap: 50px; margin-top: 20px; }
.player-buttons { display: flex; flex-direction: column; align-items: center; }
button { margin: 5px; padding: 10px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; }
.small-btn { font-size: 0.8em; padding: 5px 10px; }
.red-btn { background-color: #d32f2f; color: white; }
.blue-btn { background-color: #1976d2; color: white; }
.disabled-btn { background-color: #555 !important; cursor: not-allowed; }
.timeout-label { font-size: 0.8em; color: orange; margin-top: 4px; }
#summaryButtons, #nextGameBtn { display: none; margin-top: 20px; }
canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 9999; }

@keyframes pulse { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.05);opacity:.9;} 100%{transform:scale(1);opacity:1;} }
.pulse { animation: pulse 1s infinite; }
#timer.running { animation: pulse 1s infinite; }

.name-entry { display:flex; flex-direction:row; align-items:center; justify-content:center; gap:10px; margin-bottom:15px; }
.name-entry input { padding:10px; font-size:1em; border-radius:5px; border:none; width:160px; }
.fade-out { opacity:0; transition: opacity .6s ease, margin .6s ease; pointer-events:none; margin:0 !important; }

#fullscoreboard { border:2px solid #888; border-radius:10px; padding:20px; margin-top:100px; background-color:#000; display:flex; flex-direction:column; align-items:center; }
#fullscoreboard.locked-top { position:fixed; top:0; left:0; right:0; z-index:999; margin:0 auto; width:calc(100% - 40px); padding:10px 0; padding-left:20px; padding-right:20px; box-sizing:border-box; border-radius:10px; }
body.locked-body { padding-top:200px; }

#setupControls { margin-top:15px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; }

/* Skinny (wide) scoreboard */
#skinnyScoreboard { display:none; flex-direction:column; align-items:center; padding:10px; border:2px solid #555; background:#000; color:#fff; border-radius:8px; margin-bottom:10px; width:100%; box-sizing:border-box; height:180px; overflow:hidden; }
#skinnyScoreboard.locked { position:fixed; top:20px; left:0; right:0; margin:0 auto; z-index:999; width:calc(100% - 40px); }
#skinnyScoreboard.mirrored .skinny-player { text-align:right; }
#skinnyScoreboard.mirrored .skinny-player:last-child { text-align:left; }
.skinny-player { padding:10px; border-radius:4px; }
.skinny-player .score-value { font-size:2.2em; font-weight:bold; line-height:1; }
.winner { background-color:#ff0 !important; color:black !important; box-shadow:0 0 12px 4px #ff0; font-weight:bold; border-radius:6px; }
.winner > div:first-child { font-weight:bold !important; background-color:#ff0 !important; color:black !important; }

/* Mini (Square) streaming scoreboard */
#miniScoreboard { display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:1000; width:320px; height:320px; border:2px solid #555; background:#000; color:#fff; border-radius:12px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.5); }
body.mini-active { padding-top:360px; }
#miniScoreboard.mirrored .mini-left { order:2; text-align:right; }
#miniScoreboard.mirrored .mini-right { order:0; text-align:left; }
#miniContent { display:flex; flex-direction:column; height:100%; width:100%; font-family:'Arial Black', sans-serif; }
.mini-top { display:flex; flex:1; }
.mini-left, .mini-right { flex:1; padding:10px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
.mini-name { font-size:1em; margin-bottom:6px; text-align:center; }
.mini-score { font-size:3em; font-weight:bold; margin:0; line-height:1; }
.mini-center { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:8px; border-top:1px solid #333; border-bottom:1px solid #333; }
.mini-timer { font-size:1.4em; font-weight:bold; }
.mini-status { margin-top:4px; font-size:.95em; color:#ccc; min-height:1.2em; }
.mini-bottom { display:flex; flex:1; }
.mini-pips { flex:1; padding:8px; font-size:1.2em; display:flex; align-items:flex-start; justify-content:center; text-align:center; }
.mini-player { border-radius:8px; margin:6px; }
.mini-player.winner { background:#ff0; color:#000; box-shadow:0 0 12px 4px #ff0; }

/* Buttons */
.score-btn { width:160px; height:50px; font-size:1em; margin:5px; border:none; border-radius:6px; cursor:pointer; }
.large-tap { font-size:1.2em; height:60px; font-weight:bold; }
</style>
</head>
<body>
<!-- Skinny (wide) scoreboard -->
<div id="skinnyScoreboard">
<div id="skinnyContent" style="width: 100% !important;"></div>
<div id="compactSummary" style="margin-top: 5px; font-size: 0.9em; color: #ccc;"></div>
</div>

<!-- Mini (square) scoreboard -->
<div id="miniScoreboard">
<div id="miniContent"></div>
<div id="miniCompactSummary" style="padding:6px 8px; font-size:.9em; color:#ccc;"></div>
</div>

<div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
<img src="logo.png" alt="Air Hockey Score System Logo" style="max-width: 200px; height: auto;" />
</div>

<div class="name-entry">
<input id="player1Name" placeholder="Player 1">
<input id="player2Name" placeholder="Player 2">
</div>

<div id="setupControls" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
<select id="matchLength">
<option value="2">Best of 3</option>
<option value="3">Best of 5</option>
<option value="4" selected>Best of 7</option>
</select>
<button onclick="startMatch()">Start Match</button>
</div>

<div id="scoreSection" style="display:none">
<div id="fullscoreboard">
<div id="scoreBoard" class="scoreboard"></div>
<div id="timer">Match Time: 0:00</div>
<div id="timeoutTimer" style="font-size: 2em; color: yellow; margin-top: 10px; display: none; cursor: pointer;"></div>
<div id="betweenGamesTimer" style="font-size: 2em; margin-top: 10px; display: none; cursor: pointer;"></div>
</div>
<div id="scoreboardSpacer" style="height: 0;"></div>

<button id="nextGameBtn" onclick="startNextGame()">Start Next Game</button>

<div class="button-columns" id="buttonColumns">
<div class="player-buttons" id="leftPlayerButtons"></div>
<div class="player-buttons" id="rightPlayerButtons"></div>
</div>

<div id="tableNumberBanner" style="font-size: 1.2em; margin-top: 10px; color: yellow; display: none;"></div>
<div id="refNameBanner" style="font-size: 1em; color: #ccc; margin-top: 5px; margin-bottom: 15px; display: none;"></div>

<div id="skinnyToggleWrapper" style="margin-bottom: 10px;">
<div id="matchidDisplay" style="color: yellow; font-size: 14px; margin-top: 10px;"></div>
<hr>
<label><input type="checkbox" id="toggleSkinny" onchange="toggleSkinnyScoreboard()" /> Streaming Scoreboard</label>
</div>

<div id="miniToggleWrapper" style="margin-bottom: 10px;">
<label><input type="checkbox" id="toggleMini" onchange="toggleMiniScoreboard()" /> Mini (Square) Streaming Scoreboard</label>
</div>

<!-- NEW: one mirror to rule them all -->
<div id="mirrorAllWrapper" style="margin-bottom: 10px;">
<label><input type="checkbox" id="mirrorAll" onchange="updateMirrorState()" /> Mirror Scoreboard View (applies to Skinny, Mini, and Full)</label>
</div>

<div id="lockTopWrapper" style="margin-bottom: 10px;">
<label><input type="checkbox" id="lockTopToggle" onchange="toggleLockTop()" /> Lock Scoreboard to Top</label>
</div>

<div style="margin-top: 15px;">
<button onclick="resetMatch()">Reset Match</button>
<button onclick="flipSides()" style="margin-left: 10px;">Flip Sides</button>
</div>

<div id="gameWinner"></div>
<div id="matchWinner"></div>
<div id="history"></div>

<div id="summaryButtons">
<button onclick="exportSummary()">Export Summary</button>
<button onclick="shareSummary()">Share Summary</button>
<button onclick="generateCSV()">Export CSV</button>
<button id="startAnotherMatchBtn" style="display:none;">Start Another Match</button>
</div>

<div id="postMatchNotice" style="display:none; margin-top:16px; padding:12px 14px; border:2px dashed #f5c04f; background:rgba(245,192,79,.08); color:#f5c04f; font-weight:700; border-radius:10px; max-width:500px; margin-left:auto; margin-right:auto;">
üìã Please fill out the paper match card and have the winner (if on winners side of the chart) or loser (if on losers side of the chart) turn it into the command center.
<div id="matchCardScores" style="margin-top: 8px; font-weight: normal; color: #fff;"></div>
</div>
</div>

<canvas id="confettiCanvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
let players = [
{ id: 'player1', name: '', points: 0, games: 0, timeoutUsed: false },
{ id: 'player2', name: '', points: 0, games: 0, timeoutUsed: false }
];

const urlParams = new URLSearchParams(window.location.search);
const refFromUrl = urlParams.get('ref') || '';
const matchidFromUrl = urlParams.get('matchid') || '';
window.matchidFromUrl = matchidFromUrl;

let gameHistory = [];
let timerInterval, timeElapsed = 0, timerRunning = false;
let winGames = 4;
let isPlayer1Left = true;
let betweenGamesCountdown = null;
let betweenGamesTimeLeft = 0;

function isMirrored(){ return !!document.getElementById('mirrorAll')?.checked; }

function startMatch() {
localStorage.setItem('player1Name', document.getElementById('player1Name').value);
localStorage.setItem('player2Name', document.getElementById('player2Name').value);
players[0].name = document.getElementById('player1Name').value || 'Player 1';
players[1].name = document.getElementById('player2Name').value || 'Player 2';
winGames = parseInt(document.getElementById('matchLength').value);
players.forEach(p => { p.points = 0; p.games = 0; p.timeoutUsed = false; });
gameHistory = [];
timeElapsed = 0;
updateTimer(); updateScore(); renderButtons();
document.getElementById('matchWinner').textContent = '';
document.getElementById('gameWinner').textContent = '';
document.getElementById('summaryButtons').style.display = 'none';
document.getElementById('scoreSection').style.display = 'block';
document.querySelector('img[alt="Air Hockey Score System Logo"]').classList.add('fade-out');
document.querySelector('.name-entry').classList.add('fade-out');
document.getElementById('setupControls').classList.add('fade-out');
document.getElementById('versionLabel')?.style && (document.getElementById('versionLabel').style.display = 'none');
setTimeout(() => {
document.querySelector('img[alt="Air Hockey Score System Logo"]').style.display = 'none';
document.querySelector('.name-entry').style.display = 'none';
document.getElementById('setupControls').style.display = 'none';
}, 600);
startTimer();
updateSkinnyScoreboard();
updateMiniScoreboard();
}

document.addEventListener('DOMContentLoaded', () => {
document.getElementById('timer').addEventListener('click', toggleTimer);
const urlParams = new URLSearchParams(window.location.search);
const p1 = urlParams.get('p1');
const p2 = urlParams.get('p2');
const match = urlParams.get('match');
const table = urlParams.get('table');
const matchid = urlParams.get('matchid');
window.matchidFromUrl = matchid;
if (p1) { document.getElementById('player1Name').value = p1; localStorage.setItem('player1Name', p1); }
if (p2) { document.getElementById('player2Name').value = p2; localStorage.setItem('player2Name', p2); }
if (match && ['2','3','4'].includes(match)) { document.getElementById('matchLength').value = match; }
if (table) { const banner = document.getElementById('tableNumberBanner'); banner.textContent = `üìç Table ${table}`; banner.style.display = 'block'; }
if (matchid) { const matchInput = document.getElementById('matchid'); if (matchInput) matchInput.value = matchid; localStorage.setItem('matchid', matchid); }
const ref = urlParams.get('ref'); if (ref) { const refBanner = document.getElementById('refNameBanner'); refBanner.textContent = `üé§ Ref: ${ref}`; refBanner.style.display = 'block'; }
if (localStorage.getItem('scoreboardLocked') === 'true') { document.getElementById('lockTopToggle').checked = true; toggleLockTop(); }
if (!p1) document.getElementById('player1Name').value = localStorage.getItem('player1Name') || '';
if (!p2) document.getElementById('player2Name').value = localStorage.getItem('player2Name') || '';
const display = document.getElementById('matchidDisplay'); if (display) display.textContent = matchidFromUrl ? `üìÑ Match ID: ${matchidFromUrl}` : '‚ö†Ô∏è No Match ID in URL';
});

function renderButtons() {
// Buttons should NOT mirror; they follow the physical left/right setup only.
const left = isPlayer1Left ? players[0] : players[1];
const right = isPlayer1Left ? players[1] : players[0];
document.getElementById('leftPlayerButtons').innerHTML = generateButtonHTML(left);
document.getElementById('rightPlayerButtons').innerHTML = generateButtonHTML(right);
}

function generateButtonHTML(player) {
const colorClass = player.id === 'player1' ? 'red-btn' : 'blue-btn';
const num = player.id === 'player1' ? '1' : '2';
return `
       <button class="score-btn ${colorClass} large-tap" onclick="scorePoint('${player.id}')">+1 ${player.name}</button>
       <button class="score-btn ${colorClass}" onclick="removePoint('${player.id}')">-1 ${player.name}</button>
       <button id="timeoutBtn${num}" class="score-btn ${colorClass} large-tap" onclick="callTimeout('${player.id}')">Timeout (${player.id === 'player1' ? 'A' : 'D'})</button>
       <button class="score-btn" onclick="undoTimeout('${player.id}')">Undo Timeout</button>
       <div id="timeoutLabel${num}" class="timeout-label">${player.timeoutUsed ? 'Timeout Used' : ''}</div>
     `;
}

function scorePoint(id) {
const player = players.find(p => p.id === id);
if (player.points >= 7) return;
player.points++; updateScore(); clearBetweenGamesTimer();
if (player.points === 7) {
const nextBtn = document.getElementById('nextGameBtn');
nextBtn.style.display = 'inline-block';
nextBtn.textContent = (player.games + 1) === winGames ? 'Declare Winner' : 'Start Next Game';
}
updateSkinnyScoreboard(); updateMiniScoreboard();
}

function removePoint(id) { const p = players.find(x => x.id === id); if (p.points > 0) p.points--; updateScore(); }

function updateScore() {
const [a,b] = isPlayer1Left ? [players[0], players[1]] : [players[1], players[0]];
const left = isMirrored() ? b : a;
const right = isMirrored() ? a : b;
document.getElementById('scoreBoard').innerHTML = `
       <div style="display:flex; justify-content:space-around; gap:40px;">
         ${formatPlayerScore(left)}
         ${formatPlayerScore(right)}
       </div>`;
updateSkinnyScoreboard(); updateMiniScoreboard();
}

function formatPlayerScore(player) {
const [first, last] = player.name.split(' ');
const nameHTML = last ? `<div>${first}<br><small style=\"font-size:.7em;\">${last}</small></div>` : `<div>${first}</div>`;
const color = player.id === 'player1' ? '#d32f2f' : '#1976d2';
return `<div style=\"text-align:center;\">${nameHTML}<div style=\"font-size:3em;font-weight:bold;color:${color};margin:10px 0;cursor:pointer;\" onclick=\"scorePoint('${player.id}')\">${player.points}</div><div style=\"font-size:.9em;\">Games: ${player.games}</div></div>`;
}

function updateTimer() {
const min = Math.floor(timeElapsed / 60); const sec = timeElapsed % 60;
const timer = document.getElementById('timer');
timer.textContent = `${min}:${sec.toString().padStart(2,'0')}` + (timerRunning ? '' : ' (Paused)');
updateSkinnyScoreboard(); updateMiniScoreboard();
}

function toggleTimer() { const t = document.getElementById('timer'); if (timerRunning) { clearInterval(timerInterval); timerRunning=false; t.style.color='red'; t.classList.remove('running'); } else { startTimer(); } updateTimer(); }
function startTimer(){ timerInterval = setInterval(()=>{ timeElapsed++; updateTimer(); },1000); timerRunning=true; const t=document.getElementById('timer'); t.style.color='white'; t.classList.add('running'); updateTimer(); }

function callTimeout(id){ const p=players.find(x=>x.id===id); const num=id==='player1'?'1':'2'; if(!p.timeoutUsed){ p.timeoutUsed=true; document.getElementById(`timeoutBtn${num}`).disabled=true; document.getElementById(`timeoutBtn${num}`).classList.add('disabled-btn'); document.getElementById(`timeoutLabel${num}`).textContent='Timeout Used'; startTimeoutTimer(); } }
function undoTimeout(id){ const p=players.find(x=>x.id===id); const num=id==='player1'?'1':'2'; p.timeoutUsed=false; document.getElementById(`timeoutBtn${num}`).disabled=false; document.getElementById(`timeoutBtn${num}`).classList.remove('disabled-btn'); document.getElementById(`timeoutLabel${num}`).textContent=''; clearTimeoutTimer(); }

function updateHistory(){ const html=gameHistory.map((g,i)=>`<li>Game ${i+1}: ${g}</li>`).join(''); document.getElementById('history').innerHTML=`<h3>Previous Games:</h3><ul>${html}</ul>`; }

function startNextGame(){
const p1=players[0], p2=players[1];
const winner = p1.points===7? p1 : (p2.points===7? p2 : null);
if(winner){
winner.games++; document.getElementById('gameWinner').textContent = `${winner.name} wins this game!`;
gameHistory.push(`${p1.name} ${p1.points} - ${p2.points} ${p2.name}`); updateHistory();
if(winner.games===winGames){
document.getElementById('matchWinner').textContent = `${winner.name} wins the match!`;
clearInterval(timerInterval); clearBetweenGamesTimer(); document.getElementById('summaryButtons').style.display='block';
if (matchidFromUrl && document.getElementById('postMatchNotice')){
document.getElementById('postMatchNotice').style.display='block';
const p1S=[], p2S=[]; gameHistory.forEach(g=>{ const m=g.match(/(\d+)\s*-\s*(\d+)/); if(m){ p1S.push(m[1]); p2S.push(m[2]); }});
document.getElementById('matchCardScores').textContent = `${players[0].name} - ${p1S.join(', ')} | ${players[1].name} - ${p2S.join(', ')}`;
}
confetti({ particleCount:200, spread:70, origin:{ y:.6 } }); postMatchFormDataToSheet();
const compact=getCompactMatchSummary(); const sc=document.getElementById('compactSummary'); if(sc) sc.textContent=compact; document.getElementById('startAnotherMatchBtn').style.display='inline-block';
updateSkinnyScoreboard(winner.id); updateMiniScoreboard(winner.id);
setTimeout(()=>{ document.querySelectorAll('.skinny-player').forEach(e=>e.classList.remove('pulse')); document.querySelectorAll('.mini-player').forEach(e=>e.classList.remove('pulse')); const sw=document.querySelector('.skinny-player.winner'); const mw=document.querySelector('.mini-player.winner'); if(sw) sw.classList.add('pulse'); if(mw) mw.classList.add('pulse'); },50);
setTimeout(()=>{ const sw=document.querySelector('.skinny-player.winner'); const mw=document.querySelector('.mini-player.winner'); if(sw) sw.classList.remove('pulse'); if(mw) mw.classList.remove('pulse'); updateSkinnyScoreboard(); updateMiniScoreboard(); },4000);
} else {
document.getElementById('nextGameBtn').textContent='Start Next Game';
updateSkinnyScoreboard(winner.id); updateMiniScoreboard(winner.id); setTimeout(()=>{ updateSkinnyScoreboard(); updateMiniScoreboard(); },1500);
}
}
players.forEach(p=>{ p.points=0; p.timeoutUsed=false; });
document.getElementById('nextGameBtn').style.display='none'; document.getElementById('gameWinner').textContent='';
isPlayer1Left = !isPlayer1Left; renderButtons(); updateScore(); startBetweenGamesTimer();
}

function resetMatch(){ if(!confirm('Do you really want to reset the match?')) return; players=[{id:'player1',name:'',points:0,games:0,timeoutUsed:false},{id:'player2',name:'',points:0,games:0,timeoutUsed:false}]; gameHistory=[]; timeElapsed=0; timerRunning=false; isPlayer1Left=true; clearInterval(timerInterval); clearTimeoutTimer(); clearBetweenGamesTimer(); document.getElementById('player1Name').value=localStorage.getItem('player1Name')||''; document.getElementById('player2Name').value=localStorage.getItem('player2Name')||''; document.getElementById('matchLength').value='2'; ['scoreSection','matchWinner','gameWinner','compactSummary'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(id==='scoreSection') el.style.display='none'; else el.textContent=''; }); document.getElementById('summaryButtons').style.display='none'; document.getElementById('nextGameBtn').style.display='none'; document.getElementById('history').innerHTML=''; const lock=document.getElementById('lockTopToggle'); if(lock.checked) lock.checked=false; document.getElementById('fullscoreboard').classList.remove('locked-top'); document.body.classList.remove('locked-body'); document.getElementById('scoreboardSpacer').style.height='0'; localStorage.setItem('scoreboardLocked','false'); updateScore(); updateTimer(); updateSkinnyScoreboard(); updateMiniScoreboard(); }

function getMatchSummary(){ const [p1,p2]=players; const lines=[`Match between ${p1.name} and ${p2.name}`, `Final Score: ${p1.name} ${p1.games} - ${p2.games} ${p2.name}`,'','Game History:',...gameHistory.map((g,i)=>`Game ${i+1}: ${g}`), `Total Match Time: ${document.getElementById('timer').textContent.replace('Match Time: ','')}`]; return lines.join('\n'); }

let timeoutCountdown=null, timeoutTimeLeft=0;
function startTimeoutTimer(){ if(timeoutCountdown) return; timeoutTimeLeft=10; const el=document.getElementById('timeoutTimer'); el.textContent=`Timeout: ${timeoutTimeLeft}`; el.style.display='block'; timeoutCountdown=setInterval(()=>{ timeoutTimeLeft--; if(timeoutTimeLeft<=0){ clearTimeoutTimer(); } else { el.textContent=`Timeout: ${timeoutTimeLeft}`; } },1000); }
function clearTimeoutTimer(){ if(timeoutCountdown){ clearInterval(timeoutCountdown); timeoutCountdown=null; } document.getElementById('timeoutTimer').style.display='none'; }
document.getElementById('timeoutTimer').addEventListener('click', clearTimeoutTimer);

function exportSummary(){ const blob=new Blob([getMatchSummary()],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='AirHockeyMatchSummary.txt'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
function shareSummary(){ const s=getMatchSummary(); if(navigator.share){ navigator.share({title:'Air Hockey Match Summary',text:s}).catch(e=>{ console.error('Error sharing:',e); alert('Could not share automatically. Please screenshot your match summary instead.'); }); } else if(navigator.clipboard){ navigator.clipboard.writeText(s).then(()=>alert('Summary copied to clipboard!')).catch(err=>{ console.error('Copy failed:',err); alert('Copy failed. Please screenshot instead.'); }); } else { alert('Sharing not supported. Please screenshot.'); } }

document.addEventListener('keydown', (event) => {
const t=event.target; if(t.tagName==='INPUT'||t.tagName==='TEXTAREA') return; if(!document.getElementById('scoreSection').style.display.includes('block')) return; const leftId=isPlayer1Left? 'player1':'player2'; const rightId=isPlayer1Left? 'player2':'player1'; if(event.key==='ArrowLeft') scorePoint(leftId); if(event.key==='ArrowRight') scorePoint(rightId); if(event.key.toLowerCase()==='a') callTimeout(leftId); if(event.key.toLowerCase()==='d') callTimeout(rightId); if(event.key==='Enter' && document.getElementById('nextGameBtn').style.display!=='none') startNextGame();
});

if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js').then(()=>console.log('Service Worker Registered')); }

function generateCSV(){ const [p1,p2]=players; const winner=p1.games>p2.games?p1.name:p2.name; const today=new Date().toISOString().split('T')[0]; const location=prompt('Enter match location:','')||''; const referee=refFromUrl||prompt('Enter referee name (if any):','')||''; const notes=prompt('Additional notes:','')||''; const gameResults=gameHistory.map(g=>g).slice(0,7); while(gameResults.length<7) gameResults.push(''); const headers=['Date','Player 1','Player 2','','','Referee','','','Location','Winner','','Notes','Player 1 Game Count','Player 2 Game Count','Game 1','Game 2','Game 3','Game 4','Game 5','Game 6','Game 7']; const row=[today,p1.name,p2.name,'','',referee,'','',location,winner,'',notes,p1.games,p2.games,...gameResults]; const csv=[headers,row].map(r=>r.map(v=>`"${v}"`).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`AirHockeyMatch_${today}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

function toggleLockTop(){ const c=document.getElementById('lockTopToggle'); const board=document.getElementById('fullscoreboard'); const spacer=document.getElementById('scoreboardSpacer'); if(c.checked){ board.classList.add('locked-top'); document.body.classList.add('locked-body'); spacer.style.height = board.offsetHeight + 'px'; localStorage.setItem('scoreboardLocked','true'); } else { board.classList.remove('locked-top'); document.body.classList.remove('locked-body'); spacer.style.height='0'; localStorage.setItem('scoreboardLocked','false'); } updateScore(); }

function toggleSkinnyScoreboard(){ const skinny=document.getElementById('skinnyScoreboard'); const on=document.getElementById('toggleSkinny').checked; skinny.style.display = on ? 'flex' : 'none'; skinny.classList.toggle('locked', on); document.body.style.paddingTop = on ? '80px' : ''; if(on && document.getElementById('toggleMini').checked){ document.getElementById('toggleMini').checked=false; toggleMiniScoreboard(); } if(on && document.getElementById('lockTopToggle').checked){ document.getElementById('lockTopToggle').checked=false; toggleLockTop(); } document.getElementById('lockTopWrapper').style.display = on ? 'none' : 'block'; updateSkinnyScoreboard(); }

function toggleMiniScoreboard(){ const mini=document.getElementById('miniScoreboard'); const on=document.getElementById('toggleMini').checked; mini.style.display = on ? 'block' : 'none'; document.body.classList.toggle('mini-active', on); if(on){ if(document.getElementById('toggleSkinny').checked){ document.getElementById('toggleSkinny').checked=false; toggleSkinnyScoreboard(); } if(document.getElementById('lockTopToggle').checked){ document.getElementById('lockTopToggle').checked=false; toggleLockTop(); } document.getElementById('lockTopWrapper').style.display='none'; } else { document.getElementById('lockTopWrapper').style.display='block'; } updateMiniScoreboard(); }

function updateMirrorState(){ // apply mirror class to overlays and rerender everything
const mirror = isMirrored();
document.getElementById('skinnyScoreboard').classList.toggle('mirrored', mirror);
document.getElementById('miniScoreboard').classList.toggle('mirrored', mirror);
renderButtons(); updateScore(); updateSkinnyScoreboard(); updateMiniScoreboard();
}

function updateSkinnyScoreboard(winnerId=null){
const skinny=document.getElementById('skinnyScoreboard');
const mirror = isMirrored(); skinny.classList.toggle('mirrored', mirror);
let [L,R] = isPlayer1Left ? [players[0], players[1]] : [players[1], players[0]];
const left = mirror ? R : L; const right = mirror ? L : R;
const timerText = document.getElementById('timer').textContent.replace('Match Time: ','').replace(' (Paused)','') || '0:00';
const timeoutActive = document.getElementById('timeoutTimer').style.display==='block';
const timeoutText = document.getElementById('timeoutTimer').textContent.replace('Timeout: ','');
const timeoutHTML = timeoutActive ? `<div style=\"color:yellow;font-size:.9em;margin-top:2px;\">Timeout: ${timeoutText}</div>` : '';
const bgActive = document.getElementById('betweenGamesTimer').style.display==='block';
const bgText = document.getElementById('betweenGamesTimer').textContent.replace('Next Game: ','');
const bgHTML = bgActive ? `<div style=\"color:${betweenGamesTimeLeft<=60?'red':'yellow'};font-size:.9em;margin-top:2px;\">Next Game: ${bgText}</div>` : '';
const winId = winnerId?.trim?.() || null;
function getPipLine(forId){ return gameHistory.map(g=>{ const m=g.match(/(\d+)\s*-\s*(\d+)/); if(!m) return '‚Äì'; const s1=parseInt(m[1]), s2=parseInt(m[2]); const p1win=s1>s2; const sk=(s1===7&&s2===0)||(s2===7&&s1===0); const w=(forId==='player1'&&p1win)||(forId==='player2'&&!p1win); if(w) return '‚óè'; if(sk) return 'ü¶®'; return '‚óã'; }).join(' ');}      
const leftHTML = `<div class=\"skinny-player ${winId===left.id?'winner':''}\" style=\"text-align:left;\"><div>${left.name}</div><div class=\"score-value\" style=\"color:${left.id==='player1'?'#d32f2f':'#1976d2'};\">${left.points}</div><div style=\"font-size:1.2em;color:${left.id==='player1'?'#d32f2f':'#1976d2'};\">${getPipLine(left.id)}</div></div>`;
const rightHTML = `<div class=\"skinny-player ${winId===right.id?'winner':''}\" style=\"text-align:right;\"><div>${right.name}</div><div class=\"score-value\" style=\"color:${right.id==='player1'?'#d32f2f':'#1976d2'};\">${right.points}</div><div style=\"font-size:1.2em;color:${right.id==='player1'?'#d32f2f':'#1976d2'};\">${getPipLine(right.id)}</div></div>`;
document.getElementById('skinnyContent').innerHTML = `<div style=\"display:flex;justify-content:space-between;width:100%;padding:0 5px;font-family:'Arial Black';font-size:1.2em;\">${leftHTML}<div style=\"text-align:center;min-width:100px;font-size:1.4em;\"><div style=\"font-weight:bold;\">${timerText}</div>${timeoutHTML}${bgHTML}</div>${rightHTML}</div>`;
const summaryEl=document.getElementById('compactSummary'); if(summaryEl && gameHistory.length>0){ const c=getCompactMatchSummary(); const seg=c.split(', '); const lines=[]; for(let i=0;i<seg.length;i+=4) lines.push(seg.slice(i,i+4).join(', ')); summaryEl.innerHTML = lines.map(l=>`<div>${l}</div>`).join(''); } else if(summaryEl) summaryEl.innerHTML='';
}

function updateMiniScoreboard(winnerId=null){
const mini=document.getElementById('miniScoreboard'); if(!mini || mini.style.display==='none') return;
const mirror = isMirrored(); mini.classList.toggle('mirrored', mirror);
let [L,R] = isPlayer1Left ? [players[0], players[1]] : [players[1], players[0]];
const left = mirror ? R : L; const right = mirror ? L : R;
const timerText = document.getElementById('timer').textContent.replace('Match Time: ','').replace(' (Paused)','') || '0:00';
const timeoutActive = document.getElementById('timeoutTimer').style.display==='block';
const timeoutText = document.getElementById('timeoutTimer').textContent.replace('Timeout: ','');
const timeoutHTML = timeoutActive ? `Timeout: ${timeoutText}` : '';
const bgActive = document.getElementById('betweenGamesTimer').style.display==='block';
const bgText = document.getElementById('betweenGamesTimer').textContent.replace('Next Game: ','');
const betweenHTML = bgActive ? `Next: ${bgText}` : '';
const winId = winnerId?.trim?.() || null;
function getPipLine(forId){ return gameHistory.map(g=>{ const m=g.match(/(\d+)\s*-\s*(\d+)/); if(!m) return '‚Äì'; const s1=parseInt(m[1]), s2=parseInt(m[2]); const p1win=s1>s2; const sk=(s1===7&&s2===0)||(s2===7&&s1===0); const w=(forId==='player1'&&p1win)||(forId==='player2'&&!p1win); if(w) return '‚óè'; if(sk) return 'ü¶®'; return '‚óã'; }).join(' ');}      
const leftHTML = `<div class=\"mini-player mini-left ${winId===left.id?'winner':''}\"><div class=\"mini-name\">${left.name}</div><div class=\"mini-score\" style=\"color:${left.id==='player1'?'#d32f2f':'#1976d2'};\">${left.points}</div></div>`;
const rightHTML = `<div class=\"mini-player mini-right ${winId===right.id?'winner':''}\"><div class=\"mini-name\">${right.name}</div><div class=\"mini-score\" style=\"color:${right.id==='player1'?'#d32f2f':'#1976d2'};\">${right.points}</div></div>`;
document.getElementById('miniContent').innerHTML = `<div class=\"mini-top\">${leftHTML}${rightHTML}</div><div class=\"mini-center\"><div class=\"mini-timer\">${timerText}</div><div class=\"mini-status\">${timeoutHTML || betweenHTML || ''}</div></div><div class=\"mini-bottom\"><div class=\"mini-pips\" style=\"color:${left.id==='player1'?'#d32f2f':'#1976d2'};\">${getPipLine(left.id)}</div><div class=\"mini-pips\" style=\"color:${right.id==='player1'?'#d32f2f':'#1976d2'};\">${getPipLine(right.id)}</div></div>`;
const summaryEl=document.getElementById('miniCompactSummary'); if(summaryEl && gameHistory.length>0){ const c=getCompactMatchSummary(); const seg=c.split(', '); const lines=[]; for(let i=0;i<seg.length;i+=3) lines.push(seg.slice(i,i+3).join(', ')); summaryEl.innerHTML = lines.map(l=>`<div>${l}</div>`).join(''); } else if(summaryEl) summaryEl.innerHTML='';
}

function getCompactMatchSummary(){ const [p1,p2]=players; const i1=p1.name.charAt(0).toUpperCase()||'P1'; const i2=p2.name.charAt(0).toUpperCase()||'P2'; return gameHistory.map((g,i)=>{ const m=g.match(/(\d+)\s*-\s*(\d+)/); if(!m) return `G${i+1} ?`; const s1=parseInt(m[1],10), s2=parseInt(m[2],10); const wI=s1>s2?i1:i2, lI=s1>s2?i2:i1; const wS=Math.max(s1,s2), lS=Math.min(s1,s2); return `G${i+1} ${wI}${wS}-${lS}${lI}`; }).join(', '); }

function flipSides(){ if(!confirm('Oh sure, just flip everything mid-match. You sure about that?')) return; isPlayer1Left=!isPlayer1Left; renderButtons(); updateScore(); updateSkinnyScoreboard(); updateMiniScoreboard(); }

function startBetweenGamesTimer(){ const [p1,p2]=players; if(p1.games===winGames||p2.games===winGames){ clearBetweenGamesTimer(); return; } if(betweenGamesCountdown) return; betweenGamesTimeLeft=120; const el=document.getElementById('betweenGamesTimer'); el.style.display='block'; el.style.color='yellow'; el.textContent=`Next Game: ${betweenGamesTimeLeft}s`; betweenGamesCountdown=setInterval(()=>{ betweenGamesTimeLeft--; if(betweenGamesTimeLeft<=0){ clearBetweenGamesTimer(); } else { el.textContent=`Next Game: ${betweenGamesTimeLeft}s`; el.style.color = betweenGamesTimeLeft<=60 ? 'red' : 'yellow'; } },1000); }
function clearBetweenGamesTimer(){ if(betweenGamesCountdown){ clearInterval(betweenGamesCountdown); betweenGamesCountdown=null; } betweenGamesTimeLeft=0; const el=document.getElementById('betweenGamesTimer'); el.style.display='none'; }

function postMatchFormDataToSheet(){ const [p1,p2]=players; const winner=p1.games>p2.games?p1.name:p2.name; const fd=new FormData(); fd.append('Date', new Date().toLocaleString()); fd.append('Player 1', p1.name); fd.append('Player 2', p2.name); fd.append('P1 rank',''); fd.append('P2 rank',''); fd.append('Ref', refFromUrl); fd.append('Image',''); fd.append('Puck Color',''); fd.append('Location','Table 1'); fd.append('Winner', winner); fd.append('Video Link',''); fd.append('Notes',''); fd.append('Game Count', `${p1.games}-${p2.games}`); fd.append('Set 1',''); const clean=gameHistory.map(g=>{ const m=g.match(/(\d+)\s*-\s*(\d+)/); return m?`${m[1]} - ${m[2]}`:''; }); clean.slice(0,7).forEach((s,i)=>fd.append(`Set 1.${i+1}`, s)); for(let i=clean.length+1;i<=7;i++) fd.append(`Set 1.${i}`, ''); for(let s=2;s<=7;s++){ fd.append(`Set ${s}`,''); for(let g=1;g<=7;g++) fd.append(`Set ${s}.${g}`,''); } fd.append('ARCHIVE',''); fd.append('email',''); fd.append('OtherData',''); fd.append('P1 RE Rating',''); fd.append('P2 RE Rating',''); fd.append('Percentage P1 Win',''); fd.append('Percentage P2 Win',''); fd.append('üîí Row ID',''); fd.append('Other KVC',''); fd.append('KVC',''); fd.append('Percentage P1 WinBK',''); fd.append('Percentage P2 WinBK',''); fd.append('Other location',''); fd.append('Old Math',''); fd.append('Send Email',''); fd.append('Round',''); fd.append('KValue Image',''); fd.append('Brackelope',''); const anySkunk=clean.some(s=>s==='7 - 0'||s==='0 - 7'); fd.append('Skunk', anySkunk?'Yes':''); fd.append('VideoLink2',''); fd.append('CMC',''); fd.append('TableType',''); fd.append('TableTypeOther',''); fd.append('Match ID', matchidFromUrl); fetch('https://script.google.com/macros/s/AKfycby99JG1qwPZQAuepDhZfv7j_UWTq_2JxdZF1KiVAHvsaEr8vijfPU4_rSLrzK_psmrE/exec', { method:'POST', mode:'cors', body:fd }).then(r=>r.json()).then(d=>console.log('‚úÖ Match FormData POSTed:', d)).catch(err=>console.error('‚ùå FormData POST failed:', err)); }

document.getElementById('betweenGamesTimer').addEventListener('click', clearBetweenGamesTimer);
document.getElementById('startAnotherMatchBtn').addEventListener('click', ()=>{ const ok=confirm('‚ö†Ô∏è Warning: Match data from the current round will not appear in the next match.\nPlease export or save before continuing.'); if(ok) startAnotherMatchWithSameSettings(); });

function startAnotherMatchWithSameSettings(){ const p1n=players[0].name, p2n=players[1].name, ml=winGames; clearInterval(timerInterval); clearTimeoutTimer(); clearBetweenGamesTimer(); players=[{id:'player1',name:p1n,points:0,games:0,timeoutUsed:false},{id:'player2',name:p2n,points:0,games:0,timeoutUsed:false}]; gameHistory=[]; timeElapsed=0; timerRunning=false; isPlayer1Left=true; winGames=ml; document.getElementById('history').innerHTML=''; document.getElementById('matchWinner').textContent=''; document.getElementById('gameWinner').textContent=''; document.getElementById('summaryButtons').style.display='none'; document.getElementById('nextGameBtn').style.display='none'; document.getElementById('compactSummary').textContent=''; document.getElementById('scoreSection').style.display='block'; document.getElementById('player1Name').value=p1n; document.getElementById('player2Name').value=p2n; document.getElementById('matchLength').value=ml; updateScore(); updateTimer(); renderButtons(); updateSkinnyScoreboard(); updateMiniScoreboard(); document.getElementById('startAnotherMatchBtn').style.display='none'; startTimer(); }
</script>

  <div id="versionLabel" style="margin-top: 40px; font-size: 0.8em; color: gray;">ver2.8.3 ‚Äì (worlds)</div>
</body>
</html>
