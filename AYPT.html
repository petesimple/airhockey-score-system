<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Are You Playing Tonight?</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    h1 { margin-bottom: 10px; }
    .subtext { color: #ccc; margin-bottom: 20px; }
    form {
      background-color: #111;
      border: 2px solid #444;
      border-radius: 10px;
      padding: 20px;
      max-width: 400px;
      margin: 0 auto;
    }
    input, textarea {
      width: 100%; padding: 10px; margin-bottom: 15px;
      border: none; border-radius: 5px; font-size: 1em;
    }
    button {
      background: linear-gradient(to right, red, white, blue);
      color: black; font-weight: bold;
      border: none; padding: 10px 20px;
      border-radius: 5px; cursor: pointer;
    }
    #response { margin-top: 15px; color: yellow; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #444; padding: 8px; text-align: left; vertical-align: top;
    }
    th { background-color: #222; }
    .paid-cell, .delete-cell { text-align: center; }
    #clearBtn {
      margin-top: 15px;
      background: crimson;
      color: #fff;
    }
    .delete-btn {
      background: none;
      border: none;
      color: #ff5555;
      font-size: 1.2em;
      cursor: pointer;
    }
    .admin-note-input {
      width: 100%;
      min-height: 52px;
      resize: vertical;
      background:#0e0e0e;
      color:#fff;
      border:1px solid #333;
      border-radius:6px;
      padding:8px;
      font-family: inherit;
      margin:0;
    }
    .saved-dot {
      display:inline-block;
      width:8px;height:8px;border-radius:50%;
      background:#3ddc84;margin-left:6px;vertical-align:middle;
      opacity:0; transition:opacity .2s ease;
    }
    .saved-dot.show { opacity:1; }
    .player-note {
      white-space: pre-wrap;
      background:#0e0e0e;
      border:1px solid #333;
      border-radius:6px;
      padding:8px;
      min-height: 52px;
    }
  </style>
</head>
<body>
  <h1>üéØ Are You Playing Tonight?</h1>
  <div class="subtext">Fill out this form to get added to tonight's tournament list.</div>

  <!-- Normal (player) view -->
  <div id="formWrapper">
    <form id="ayptForm">
      <input type="text" id="firstName" placeholder="First Name" required />
      <input type="text" id="lastName" placeholder="Last Name" required />
      <input type="tel" id="cellNumber" placeholder="Cell Number" required />
      <textarea id="notes" rows="3" placeholder="Any notes for the TD? (optional)"></textarea>
      <button type="submit">Submit</button>
    </form>
    <div id="response"></div>
  </div>

  <!-- Admin view -->
  <div id="adminWrapper" style="display:none;">
    <h2>üìã AYPT Signups (Admin View)</h2>
    <table id="signupTable">
      <thead>
        <tr>
          <th>First</th>
          <th>Last</th>
          <th>Cell</th>
          <th>Player Note (read-only)</th>
          <th>Admin Notes (private)</th>
          <th>Signed Up</th>
          <th>Paid</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="clearBtn">üóëÔ∏è Clear All Players</button>
  </div>

<script>
(function(){
  const params = new URLSearchParams(window.location.search);
  const isAdmin = params.get("admin") === "1";

  const STORAGE_KEY = "ayptSignups";

  function loadSignups(){
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
  }
  function saveSignups(list){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  // Escape helper for safe text injection
  function esc(str){
    return String(str || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function renderTable(){
    const tbody = document.querySelector("#signupTable tbody");
    tbody.innerHTML = "";
    loadSignups().forEach((s, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(s.firstName)}</td>
        <td>${esc(s.lastName)}</td>
        <td>${esc(s.cellNumber)}</td>
        <td><div class="player-note">${esc(s.notes)}</div></td>
        <td>
          <textarea class="admin-note-input" data-index="${idx}" placeholder="Private admin notes...">${esc(s.adminNotes || "")}</textarea>
          <span class="saved-dot" id="saved-${idx}" title="Saved"></span>
        </td>
        <td>${esc(s.timestamp || "")}</td>
        <td class="paid-cell">
          <input type="checkbox" ${s.paid ? "checked" : ""} data-index="${idx}">
        </td>
        <td class="delete-cell">
          <button class="delete-btn" data-index="${idx}" title="Delete Player">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function debounce(fn, delay=300){
    let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), delay); };
  }

  if(isAdmin){
    // Admin mode
    document.getElementById("formWrapper").style.display = "none";
    document.getElementById("adminWrapper").style.display = "block";

    renderTable();

    const tbody = document.querySelector("#signupTable tbody");

    // Paid toggle
    tbody.addEventListener("change", function(e){
      if(e.target.type === "checkbox"){
        const index = e.target.getAttribute("data-index");
        const signups = loadSignups();
        signups[index].paid = e.target.checked;
        saveSignups(signups);
      }
    });

    // Delete player
    tbody.addEventListener("click", function(e){
      if(e.target.classList.contains("delete-btn")){
        const index = e.target.getAttribute("data-index");
        const signups = loadSignups();
        const player = signups[index];
        if(confirm(`Remove ${player.firstName} ${player.lastName}?`)){
          signups.splice(index, 1);
          saveSignups(signups);
          renderTable();
        }
      }
    });

    // Admin notes (private) auto-save
    const saveAdminNotes = debounce((index, value) => {
      const list = loadSignups();
      if(list[index]){
        list[index].adminNotes = value;
        saveSignups(list);
        const dot = document.getElementById(`saved-${index}`);
        if(dot){ dot.classList.add("show"); setTimeout(()=>dot.classList.remove("show"), 800); }
      }
    }, 250);

    tbody.addEventListener("input", function(e){
      if(e.target.classList.contains("admin-note-input")){
        const index = e.target.getAttribute("data-index");
        saveAdminNotes(index, e.target.value);
      }
    });
    tbody.addEventListener("blur", function(e){
      if(e.target.classList.contains("admin-note-input")){
        const index = e.target.getAttribute("data-index");
        const list = loadSignups();
        if(list[index]){
          list[index].adminNotes = e.target.value;
          saveSignups(list);
        }
      }
    }, true);

    // Clear all
    document.getElementById("clearBtn").addEventListener("click", function(){
      if(confirm("Are you sure you want to clear ALL players? This cannot be undone.")){
        localStorage.removeItem(STORAGE_KEY);
        renderTable();
      }
    });

  } else {
    // Player form mode
    const form = document.getElementById("ayptForm");
    form.addEventListener("submit", function(e){
      e.preventDefault();
      const entry = {
        firstName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        cellNumber: document.getElementById("cellNumber").value.trim(),
        notes: document.getElementById("notes").value.trim(), // player-provided note (read-only in admin)
        timestamp: new Date().toLocaleString(),
        paid: false,
        adminNotes: "" // private, only editable in admin
      };
      const list = loadSignups();
      list.push(entry);
      saveSignups(list);

      document.getElementById("response").innerHTML =
        `<strong>Thanks ${entry.firstName}, you are signed up ‚úÖ</strong>`;
      form.reset();
    });
  }
})();
</script>
</body>
</html>
