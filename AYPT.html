<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Are You Playing Tonight?</title>
  <link rel="icon" type="image/png" href="AYPTlogo.png">

  <!-- Bootstrap 5 CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{ --ah-bg:#000; --ah-panel:#0f0f10; --ah-border:#2d2f33; --ah-text:#f5f7fa; --ah-muted:#9aa1a9; }
    body{ background:var(--ah-bg); color:var(--ah-text); }
    .ah-card{ background:var(--ah-panel); border:1px solid var(--ah-border); }
    .ah-muted{ color:var(--ah-muted); }
    .btn-gradient{ background: linear-gradient(90deg, #e53935, #ffffff, #1e88e5); color:#000; font-weight:700; border:none; }
    .btn-gradient:hover{ opacity:.9; color:#000; }
    .table thead th{ position:sticky; top:0; z-index:1; background:#141519; }
    .admin-note{ width:100%; min-height:2.6rem; resize:vertical; }
    .saved-dot{ display:inline-block; width:8px; height:8px; margin-left:.4rem; border-radius:50%; background:#3ddc84; opacity:0; transition:opacity .2s ease; }
    .saved-dot.show{ opacity:1; }
    .aypt-logo{ height:40px; width:auto; border-radius:8px; object-fit:contain; box-shadow:0 0 0 1px rgba(255,255,255,0.06); }
    @media (min-width:768px){ .aypt-logo{ height:48px; } }
    .form-label{ color:var(--ah-text)!important; font-weight:600; }
    #eventBanner{ display:none; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center gap-3">
      <img src="AYPTlogo.png" alt="AYPT" class="aypt-logo" />
      <div>
        <h1 class="h4 fw-bold mb-0">Are You Playing Tonight?</h1>
        <div class="ah-muted small" id="subtitle">Fill out this form to get added to tonight's tournament list.</div>
      </div>
    </div>
    <a id="modeSwitch" class="btn btn-outline-light btn-sm mt-3" href="#">Switch View</a>
  </div>

  <!-- Player Event Banner -->
  <div class="container" id="eventBanner">
    <div class="alert alert-warning d-flex align-items-center gap-2 mb-3" role="alert">
      <i class="bi bi-megaphone-fill"></i>
      <strong class="me-1">Event:</strong>
      <span id="eventTitleText"></span>
    </div>
  </div>

  <!-- Player Form View -->
  <div id="formView" class="row justify-content-center">
    <div class="col-12 col-sm-10 col-md-8 col-lg-6">
      <div class="card ah-card shadow-sm">
        <div class="card-body">
          <form id="ayptForm" novalidate>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" id="firstName" class="form-control form-control-lg" required />
              </div>
              <div class="col-12 col-md-6">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" id="lastName" class="form-control form-control-lg" required />
              </div>
              <div class="col-12">
                <label for="cellNumber" class="form-label">Cell Number</label>
                <input
                  type="tel"
                  id="cellNumber"
                  inputmode="numeric"
                  autocomplete="tel"
                  class="form-control form-control-lg"
                  required
                />
                <div class="invalid-feedback">Enter a valid US cell number like (555) 123-4567.</div>
              </div>
              <div class="col-12">
                <label for="notes" class="form-label">Notes for TD (optional)</label>
                <textarea id="notes" rows="3" class="form-control"></textarea>
              </div>
              <div class="col-12 d-grid">
                <button id="submitBtn" class="btn btn-gradient btn-lg" type="submit">
                  <span id="btnIdle"><i class="bi bi-send-fill me-1"></i> Submit</span>
                  <span id="btnBusy" class="d-none"><span class="spinner-border spinner-border-sm me-2"></span>Submitting…</span>
                </button>
              </div>
              <div class="col-12">
                <div id="response" class="small text-warning"></div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <p class="text-center mt-3 small ah-muted">Admin view: append <code>?admin=1</code> to the URL.</p>
    </div>
  </div>

  <!-- Admin View -->
  <div id="adminView" class="d-none">
    <div class="card ah-card shadow-sm mb-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h2 class="h5 mb-0 d-flex align-items-center gap-2">
          <img src="AYPTlogo.png" alt="AYPT" class="aypt-logo" style="height:28px;border-radius:6px" />
          AYPT Signups (Admin)
        </h2>
        <div class="d-flex gap-2">
          <button id="refreshBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-arrow-clockwise me-1"></i> Refresh</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="signupTable" class="table table-dark table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>#</th>
                <th>First</th>
                <th>Last</th>
                <th>Cell</th>
                <th>Player Notes</th>
                <th>Signed Up</th>
                <th class="text-center">Paid</th>
                <th style="min-width:220px;">Admin Notes</th>
              </tr>
            </thead>
            <tbody><!-- rows injected --></tbody>
          </table>
        </div>
      </div>
      <div class="card-footer small ah-muted">Tip: tap the phone number to dial on mobile.</div>
    </div>

    <!-- Event Title tool (no Apps Script changes needed) -->
    <div class="card ah-card shadow-sm">
      <div class="card-header">
        <strong>Event Title</strong> <span class="ah-muted small">(resets 3:00 AM Central)</span>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-12 col-lg-8">
            <input id="eventTitleInput" class="form-control" placeholder="e.g., Friday Night Lights - Doubles" />
          </div>
          <div class="col-12 col-lg-4 d-grid d-lg-flex gap-2">
            <button id="saveEventTitleBtn" class="btn btn-gradient" type="button">Save Title</button>
            <button id="clearEventTitleBtn" class="btn btn-outline-light" type="button">Clear</button>
          </div>
        </div>
        <div id="eventTitleStatus" class="small ah-muted mt-2"></div>
        <div class="small mt-1">Current: <span id="eventTitleCurrent" class="text-info">(none)</span></div>
      </div>
    </div>

    <div id="status" class="small ah-muted mt-3"></div>
  </div>

  <script>
    // ==============================
    // CONFIG
    // ==============================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzoQ7YLUs_S1pi8mQCc7u__44wf7TRZd9k40vKfPBQi4mTBYt5tZPcI9PR5Hx7E0BRU/exec";
    const ADMIN_CODE = "2580";
    const EVENT_MARKER = "__EVENT__"; // firstName marker row for event title (no Apps Script change)

    // ==============================
    // UTILITIES
    // ==============================
    const $ = (sel, root=document) => root.querySelector(sel);
    function isAdminRequest(){ return new URLSearchParams(location.search).get("admin") === "1"; }

    function setBusy(b){
      const btn = $("#submitBtn"); if(!btn) return;
      btn.disabled = b;
      $("#btnIdle").classList.toggle("d-none", b);
      $("#btnBusy").classList.toggle("d-none", !b);
    }

    function esc(s){ return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
    function fmtLocal(iso){ if(!iso) return ""; try { return new Date(iso).toLocaleString(); } catch { return iso; } }

    // JSONP helper
    function jsonp(url, params = {}, timeoutMs = 12000){
      return new Promise((resolve, reject) => {
        const cb = "AYPT_CB_" + Math.random().toString(36).slice(2);
        params.callback = cb;
        const qs = new URLSearchParams(params).toString();
        const s = document.createElement("script");
        s.src = `${url}?${qs}`;
        s.id  = cb;
        const timeout = setTimeout(() => { cleanup(); reject(new Error("JSONP timeout")); }, timeoutMs);
        window[cb] = (data) => { cleanup(); resolve(data); };
        function cleanup(){
          clearTimeout(timeout);
          const el = document.getElementById(cb); if (el) el.remove();
          try { delete window[cb]; } catch(_) { window[cb] = undefined; }
        }
        document.body.appendChild(s);
      });
    }

    // ==============================
    // PHONE MASK (caret-safe, paste-safe)
    // ==============================
    function digitsOnly(str){ return String(str||"").replace(/\D+/g,""); }
    function isValidUSPhoneDigits(d){
      if(d.length === 11 && d.startsWith("1")) d = d.slice(1);
      if(d.length !== 10) return false;
      const area = d.slice(0,3), exch = d.slice(3,6);
      return (area[0] >= "2" && exch[0] >= "2");
    }
    function formatFromDigits(d){
      let lead = "";
      if(d.startsWith("1")){ lead = "1 "; d = d.slice(1); }
      if(d.length <= 3) return lead + d;
      if(d.length <= 6) return `${lead}(${d.slice(0,3)}) ${d.slice(3)}`;
      return `${lead}(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}`;
    }
    function setCaretByDigitIndex(input, digitIndex, formatted){
      if(typeof input.setSelectionRange !== "function") return;
      if(digitIndex <= 0){
        const first = formatted.search(/\d/);
        const pos = first === -1 ? formatted.length : first;
        try{ input.setSelectionRange(pos, pos); }catch(_){}
        return;
      }
      let count = 0, i = 0;
      for(; i < formatted.length; i++){
        if(/\d/.test(formatted[i])) count++;
        if(count >= digitIndex) break;
      }
      const pos = Math.min(i+1, formatted.length);
      try{ input.setSelectionRange(pos, pos); }catch(_){}
    }

    // ==============================
    // AYPT DAY (flips 3:00 AM America/Chicago)
    // ==============================
    function chicagoHour(now=new Date()){
      return parseInt(new Intl.DateTimeFormat('en-US',{ timeZone:'America/Chicago', hour:'2-digit', hour12:false }).format(now),10);
    }
    function chicagoYMD(now=new Date()){
      return new Intl.DateTimeFormat('en-CA',{ timeZone:'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' }).format(now);
    }
    function ayptDay(now=new Date()){
      let ymd = chicagoYMD(now);
      const h = chicagoHour(now);
      if(h < 3){
        const [y,m,d] = ymd.split('-').map(Number);
        const dt = new Date(Date.UTC(y, m-1, d));
        dt.setUTCDate(dt.getUTCDate()-1);
        const y2 = dt.getUTCFullYear();
        const m2 = String(dt.getUTCMonth()+1).padStart(2,'0');
        const d2 = String(dt.getUTCDate()).padStart(2,'0');
        ymd = `${y2}-${m2}-${d2}`;
      }
      return ymd;
    }

    // ==============================
    // PLAYER FORM SUBMIT
    // ==============================
    async function handleSubmit(e){
      e.preventDefault();
      const responseEl = $("#response");
      responseEl.textContent = "";

      const firstName = $("#firstName").value.trim();
      const lastName  = $("#lastName").value.trim();
      const cellRaw   = $("#cellNumber").value;
      const notes     = $("#notes").value.trim();

      if(!firstName || !lastName){
        responseEl.textContent = "Please complete First and Last.";
        return;
      }

      const d = digitsOnly(cellRaw);
      if(!isValidUSPhoneDigits(d)){
        $("#cellNumber").classList.add("is-invalid");
        responseEl.textContent = "Please enter a valid US cell number.";
        return;
      }

      const cell = (function normalizePhone(str){
        const d = digitsOnly(String(str||"").trim());
        if(d.length === 11 && d.startsWith("1")) return "+1" + d.slice(1);
        if(d.length === 10) return "+1" + d;
        return String(str||"").trim();
      })(cellRaw);

      setBusy(true);
      try {
        const data = await jsonp(SCRIPT_URL, { firstName, lastName, cellNumber: cell, notes });
        if (data && (data.ok || data.result === "success")) {
          responseEl.innerHTML = `<strong>Thanks ${esc(firstName)}, you’re signed up ✅. See you at 8PM!! PLAY PUCK</strong>`;
          $("#ayptForm").reset();
          $("#cellNumber").classList.remove("is-invalid");
        } else {
          responseEl.textContent = "Error: " + (data && data.message ? data.message : "Submission failed");
        }
      } catch (err) {
        console.error(err);
        responseEl.textContent = "Submission timed out. Please try again.";
      } finally {
        setBusy(false);
      }
    }

    // ==============================
    // ADMIN LIST
    // ==============================
    async function loadAdminTable(){
      const statusEl = $("#status");
      const tbody = $("#signupTable tbody");
      statusEl.textContent = "Loading…";
      tbody.innerHTML = "";

      try {
        const data = await jsonp(SCRIPT_URL, { list: "1" });
        if (!data || !data.ok) throw new Error(data && data.message || "Load failed");
        const rows = data.rows || [];

        rows.forEach((r) => {
          // Hide control rows entirely in admin table
          if (r.firstName === EVENT_MARKER) return;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="text-muted">${esc(r.id)}</td>
            <td>${esc(r.firstName)}</td>
            <td>${esc(r.lastName)}</td>
            <td><a class="text-decoration-none" href="tel:${esc(r.cell)}">${esc(r.cell)}</a></td>
            <td>${esc(r.notes)}</td>
            <td>${fmtLocal(r.timestamp)}</td>
            <td class="text-center">
              <input type="checkbox" class="form-check-input paid-toggle" data-id="${esc(r.id)}" ${r.paid ? "checked" : ""}>
            </td>
            <td>
              <textarea class="form-control admin-note" rows="2" data-id="${esc(r.id)}" placeholder="Private admin notes...">${esc(r.adminNotes || "")}</textarea>
              <span class="saved-dot" id="saved-${esc(r.id)}" title="Saved"></span>
            </td>
          `;
          tbody.appendChild(tr);
        });

        const count = rows.filter(r => r.firstName !== EVENT_MARKER).length;
        statusEl.textContent = `${count} signups loaded`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to load signups.";
      }
    }

    // Paid toggle + notes saving
    function wireAdminTableEvents(){
      const table = document.getElementById('signupTable');
      if(!table || table.dataset.wired === '1') return;
      table.dataset.wired = '1';

      table.addEventListener('change', async (e) => {
        const t = e.target;
        if(!t.matches('.paid-toggle')) return;
        const id = t.getAttribute('data-id');
        const paid = t.checked ? '1' : '0';
        try { await jsonp(SCRIPT_URL, { update:'1', id, paid }); pulseSaved(id); }
        catch (err){ console.error(err); document.getElementById('status').textContent = 'Failed to update Paid.'; }
      });

      let noteTimer = null;
      table.addEventListener('input', (e) => {
        const t = e.target;
        if(!t.matches('.admin-note')) return;
        const id = t.getAttribute('data-id');
        const v  = t.value;
        clearTimeout(noteTimer);
        noteTimer = setTimeout(async () => {
          try { await jsonp(SCRIPT_URL, { update:'1', id, adminNote:v }); pulseSaved(id); }
          catch (err){ console.error(err); document.getElementById('status').textContent = 'Failed to save admin notes.'; }
        }, 350);
      });
    }

    function pulseSaved(id){
      const dot = document.getElementById(`saved-${id}`);
      if(dot){ dot.classList.add("show"); setTimeout(()=>dot.classList.remove("show"), 800); }
    }

    // ==============================
    // EVENT TITLE via control row (no script change)
    // ==============================
    function extractTodayEventTitleFromRows(rows){
      const today = ayptDay(new Date());
      // Walk from end to get latest control row for today
      for(let i = rows.length - 1; i >= 0; i--){
        const r = rows[i];
        if(r.firstName === EVENT_MARKER && r.lastName === today){
          return String(r.notes || "").trim();
        }
      }
      return "";
    }

    async function readEventTitle(){
      try {
        const data = await jsonp(SCRIPT_URL, { list:"1" });
        if(!data || !data.ok) return "";
        return extractTodayEventTitleFromRows(data.rows || []);
      } catch { return ""; }
    }

    async function writeEventTitle(title){
      // Append a control row using existing submit pipeline
      const today = ayptDay(new Date());
      return await jsonp(SCRIPT_URL, {
        firstName: EVENT_MARKER,
        lastName: today,
        cellNumber: "",
        notes: title
      });
    }

    function applyEventBanner(title){
      const banner = document.getElementById('eventBanner');
      const textEl = document.getElementById('eventTitleText');
      const currEl = document.getElementById('eventTitleCurrent');
      if(currEl) currEl.textContent = title ? title : '(none)';
      if(title){
        if(textEl) textEl.textContent = title;
        if(banner) banner.style.display = 'block';
      }else{
        if(textEl) textEl.textContent = '';
        if(banner) banner.style.display = 'none';
      }
    }

    // ==============================
    // ADMIN PASSCODE GATE
    // ==============================
    function requireAdminAccess(){
      const stored = sessionStorage.getItem("ayptAdminOK");
      if(stored === "true") return true;
      const code = prompt("Enter admin passcode:");
      if(code === ADMIN_CODE){
        sessionStorage.setItem("ayptAdminOK","true");
        return true;
      }
      alert("Incorrect code. Returning to player form.");
      window.location.href = location.pathname;
      return false;
    }

    // ==============================
    // INIT
    // ==============================
    document.addEventListener("DOMContentLoaded", async () => {
      // Phone input wiring (single, clean, caret-safe)
      const cellInput = document.getElementById("cellNumber");
      if(cellInput){
        cellInput.addEventListener("input", () => {
          const before = cellInput.value;
          const caret = cellInput.selectionStart ?? before.length;
          const leftDigits = digitsOnly(before.slice(0, caret)).slice(0, 11).length;
          const digits = digitsOnly(before).slice(0, 11);
          const formatted = formatFromDigits(digits);
          cellInput.value = formatted;
          setCaretByDigitIndex(cellInput, leftDigits, formatted);
          const ok = isValidUSPhoneDigits(digits);
          cellInput.classList.toggle("is-invalid", !ok && digits.length > 0);
        });
        cellInput.addEventListener("paste", (e) => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData("text") || "";
          const digits = digitsOnly(text).slice(0, 11);
          const formatted = formatFromDigits(digits);
          document.execCommand("insertText", false, formatted);
        });
        cellInput.addEventListener("blur", () => {
          const digits = digitsOnly(cellInput.value).slice(0, 11);
          const ok = isValidUSPhoneDigits(digits);
          cellInput.classList.toggle("is-invalid", !ok);
          cellInput.value = formatFromDigits(digits);
        });
      }

      // Load event title for both views on start
      try {
        const t = await readEventTitle();
        applyEventBanner(t);
        const input = document.getElementById('eventTitleInput');
        if(input) input.value = t;
      } catch {}

      const adminReq = isAdminRequest();

      if(adminReq){
        if(!requireAdminAccess()) return;
        $("#formView").classList.add("d-none");
        $("#adminView").classList.remove("d-none");
        $("#subtitle").textContent = "Admin view - live list from Google Sheets.";
        $("#modeSwitch").href = location.pathname;
        $("#modeSwitch").textContent = "Player Form";
        wireAdminTableEvents();
        loadAdminTable();

        // Save/Clear event title
        const saveBtn  = document.getElementById('saveEventTitleBtn');
        const clearBtn = document.getElementById('clearEventTitleBtn');
        const input    = document.getElementById('eventTitleInput');
        const statusEl = document.getElementById('eventTitleStatus');

        if(saveBtn && input){
          saveBtn.addEventListener('click', async () => {
            const title = String(input.value || '').trim();
            try{
              await writeEventTitle(title);
              applyEventBanner(title);
              statusEl.textContent = 'Saved.';
              setTimeout(()=> statusEl.textContent = '', 1200);
            }catch(e){ console.error(e); statusEl.textContent = 'Save failed.'; }
          });
        }
        if(clearBtn){
          clearBtn.addEventListener('click', async () => {
            try{
              await writeEventTitle('');
              if(document.getElementById('eventTitleInput')) document.getElementById('eventTitleInput').value = '';
              applyEventBanner('');
              statusEl.textContent = 'Cleared.';
              setTimeout(()=> statusEl.textContent = '', 1200);
            }catch(e){ console.error(e); statusEl.textContent = 'Clear failed.'; }
          });
        }

      }else{
        $("#formView").classList.remove("d-none");
        $("#adminView").classList.add("d-none");
        $("#subtitle").textContent = "Fill out this form to get added to tonight's tournament list.";
        const u = new URL(location.href); u.searchParams.set("admin","1");
        $("#modeSwitch").href = u.toString();
        $("#modeSwitch").textContent = "Admin View";
        $("#ayptForm").addEventListener("submit", handleSubmit);

        // Light poll so open tablets drop the banner right after 3 AM
        setInterval(async () => {
          try{ const t = await readEventTitle(); applyEventBanner(t); } catch {}
        }, 60 * 1000);
      }
    });
  </script>
</body>
</html>
